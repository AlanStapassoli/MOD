
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOOODY – Viewer</title>
<style>
  html,body{ height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; background:#f8fafc }
  header{ padding:12px 16px; background:#fff; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; gap:10px }
  h1{ margin:0; font-size:16px }
  .muted{ color:#6b7280; font-size:12px }
  #app{ height:calc(100% - 58px); display:flex; }
  #canvasWrap{ position:relative; flex:1; background:#fff }
  #canvasWrap canvas{ width:100%; height:100%; display:block }
  .error{ position:absolute; left:12px; bottom:12px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:8px 12px; border-radius:10px; font-size:12px; max-width:min(560px, 90vw) }
</style>
<!-- Three r146 (clássico) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/GLTFLoader.js"></script>
<!-- Draco opcional (ative se exportar com Draco) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/loaders/DRACOLoader.js"></script>
</head>
<body>
<header>
  <h1>MOOODY – Viewer</h1>
  <div class="muted" id="info"></div>
</header>

<div id="app">
  <div id="canvasWrap">
    <canvas id="c"></canvas>
    <div id="err" class="error" style="display:none;"></div>
  </div>
</div>

<script>
  // Query params
  const params = new URLSearchParams(location.search);
  const model = params.get('model') || 'BASE.glb';  // caminho relativo à raiz do site
  const scale = parseFloat(params.get('scale') || '0.01'); // 1mm -> 0.01 unidade, ajuste se quiser
  document.getElementById('info').textContent = `Modelo: ${model}  •  Escala: ${scale}`;

  // Three.js
  const canvas = document.getElementById('c');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
  const scene = new THREE.Scene(); scene.background = new THREE.Color(0xffffff);
  const camera = new THREE.PerspectiveCamera(45, 2, 0.1, 2000); camera.position.set(0.6,0.6,0.9);
  const controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff, 0.6));
  const dir = new THREE.DirectionalLight(0xffffff, 0.8); dir.position.set(1,2,1); scene.add(dir);

  const gltfLoader = new THREE.GLTFLoader();
  // (Opcional) Draco (use se seus GLBs tiverem Draco)
  const draco = new THREE.DRACOLoader();
  draco.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/libs/draco/");
  gltfLoader.setDRACOLoader(draco);

  let object = null;

  function showError(m){ const e=document.getElementById('err'); e.style.display=''; e.textContent=String(m); console.error(m); }
  function clearError(){ const e=document.getElementById('err'); e.style.display='none'; e.textContent=''; }

  function fitCameraTo(obj){
    const box = new THREE.Box3().setFromObject(obj);
    const size = new THREE.Vector3(); const center = new THREE.Vector3();
    box.getSize(size); box.getCenter(center);
    const maxDim = Math.max(size.x,size.y,size.z) || 1;
    const fov = camera.fov * (Math.PI/180);
    let distance = (maxDim/2) / Math.tan(fov/2); distance *= 1.4;
    camera.position.set(center.x + distance*0.7, center.y + distance*0.7, center.z + distance*0.7);
    camera.near = Math.max(0.001, distance/100); camera.far = Math.max(10, distance*10);
    camera.updateProjectionMatrix(); controls.target.copy(center); controls.update();
  }

  function resize(){
    const w = canvas.clientWidth || window.innerWidth;
    const h = canvas.clientHeight || window.innerHeight - 58; // header
    renderer.setSize(w,h,false); camera.aspect = w/h; camera.updateProjectionMatrix();
  }
  window.addEventListener('resize', resize);

  (function animate(){ resize(); controls.update(); renderer.render(scene, camera); requestAnimationFrame(animate); })();

  // Carrega o GLB
  (async function(){
    try{
      clearError();
      gltfLoader.load(model, (gltf)=>{
        object = gltf.scene || gltf.scenes?.[0];
        object.scale.set(scale, scale, scale);
        scene.add(object);
        fitCameraTo(object);
      }, undefined, (err)=>{
        showError("Falha ao carregar: " + (err?.message || err));
      });
    } catch (e){ showError(e.message || e); }
  })();
</script>
</body>
</html>
